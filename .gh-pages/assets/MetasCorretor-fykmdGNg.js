import{r as d,Z as k,j as a,B as A}from"./index-B1T0EHdw.js";import{C as V}from"./card-Crbks64Q.js";import{I as X}from"./index-9jhqUY8l.js";import{T as se,a as oe,b as te,c as re}from"./tabs-CPnQnbxv.js";import{S as T,a as _,b as B,c as R,d as D}from"./select-Beuwlf-E.js";import{T as ne,a as ie,b as K,c as M,d as le,e as C}from"./table-DcIYnpta.js";import{c as ce}from"./confetti.module-BxKCmZ95.js";import{a as de,b as me}from"./exporters-DL7GtC-r.js";import{R as ue,B as xe,X as fe,Y as he,z as pe,E as je,F as Y}from"./BarChart-Co3S3kis.js";import"./index-CLAOn620.js";import"./check--Ekm-BHX.js";const y=[{key:0,label:"Jan"},{key:1,label:"Fev"},{key:2,label:"Mar"},{key:3,label:"Abr"},{key:4,label:"Mai"},{key:5,label:"Jun"},{key:6,label:"Jul"},{key:7,label:"Ago"},{key:8,label:"Set"},{key:9,label:"Out"},{key:10,label:"Nov"},{key:11,label:"Dez"}];function w(n){return`R$ ${Math.round(n||0).toLocaleString("pt-BR")}`}function P(n,x){return!x||x<=0?0:Math.max(0,Math.min(100,n/x*100))}function be(n){return n>=90?"bg-green-500":n>=50?"bg-yellow-500":"bg-red-500"}function ge({value:n,colorClass:x}){return a.jsx("div",{className:"h-2 w-full rounded bg-muted",children:a.jsx("div",{className:`h-2 rounded ${x}`,style:{width:`${Math.max(0,Math.min(100,n))}%`}})})}function Re(){const n=new Date,x=n.getFullYear(),[i,N]=d.useState(x),[l,p]=d.useState(n.getMonth()),[m,f]=d.useState([]),[g,z]=d.useState({}),[S,O]=d.useState(null),[we,F]=d.useState(!1),I=d.useRef(new Set);d.useEffect(()=>{let e=!0;return(async()=>{const{data:s,error:o}=await k.from("corretores").select("id, nome").order("nome");if(o){console.error("[MetasCorretor] load brokers",o);return}e&&(f(s),O(t=>{var c;return t??((c=s==null?void 0:s[0])==null?void 0:c.id)??null}))})(),()=>{e=!1}},[]),d.useEffect(()=>{let e=!0;return(async()=>{if(m.length){F(!0);try{const{data:s,error:o}=await k.from("metas_corretor").select("corretor_id, mes, ano, meta_piso, observacoes").eq("ano",i);o&&console.error("[MetasCorretor] load metas",o);const t=new Date(i,0,1).toISOString(),c=new Date(i+1,0,1).toISOString(),{data:u,error:v}=await k.from("vendas").select("vendedor, vgv, dataCompetencia").gte("dataCompetencia",t).lt("dataCompetencia",c);v&&console.error("[MetasCorretor] load vendas",v);const W=new Map(m.map(r=>[r.id,r.nome])),ee=new Map(m.map(r=>[r.nome,r.id])),E=new Map;for(const r of u??[]){const h=r.vendedor,b=h?ee.get(h):void 0;if(!b)continue;const ae=new Date(r.dataCompetencia).getMonth(),L=`${b}-${ae}`;E.set(L,(E.get(L)||0)+(Number(r.vgv)||0))}const j={};for(const r of y)j[r.key]={};for(const r of m)for(const h of y)j[h.key][r.id]={corretorId:r.id,nome:W.get(r.id)||r.id,ano:i,mes:h.key,metaPiso:0,realizado:E.get(`${r.id}-${h.key}`)||0,observacoes:void 0};for(const r of s??[]){const h=r.corretor_id,b=Number(r.mes)-1;!j[b]||!j[b][h]||(j[b][h].metaPiso=Number(r.meta_piso)||0,j[b][h].observacoes=r.observacoes||void 0)}if(!e)return;z(j)}finally{e&&F(!1)}}})(),()=>{e=!1}},[i,m]);const $=d.useMemo(()=>Object.values(g[l]||{}),[g,l]),H=d.useMemo(()=>S?y.map(({key:e,label:s})=>{var t;const o=(t=g[e])==null?void 0:t[S];return{mes:s,metaPiso:(o==null?void 0:o.metaPiso)||0,realizado:(o==null?void 0:o.realizado)||0}}):[],[S,g]);async function J(e,s,o){const t={corretor_id:e,ano:i,mes:s+1,meta_piso:o},{error:c}=await k.from("metas_corretor").upsert(t,{onConflict:"corretor_id,ano,mes"});c&&console.error("[MetasCorretor] upsert meta_piso",c)}async function q(e,s,o){const t={corretor_id:e,ano:i,mes:s+1,observacoes:o},{error:c}=await k.from("metas_corretor").upsert(t,{onConflict:"corretor_id,ano,mes"});c&&console.error("[MetasCorretor] upsert observacoes",c)}const Z=(e,s,o)=>{z(t=>{var c,u;return{...t,[s]:{...t[s],[e]:{...((c=t[s])==null?void 0:c[e])||{corretorId:e,nome:((u=m.find(v=>v.id===e))==null?void 0:u.nome)||e,ano:i,mes:s,realizado:0},metaPiso:o}}}})},G=(e,s,o)=>{z(t=>{var c,u;return{...t,[s]:{...t[s],[e]:{...((c=t[s])==null?void 0:c[e])||{corretorId:e,nome:((u=m.find(v=>v.id===e))==null?void 0:u.nome)||e,ano:i,mes:s,realizado:0},observacoes:o}}}})};d.useEffect(()=>{const e=Object.values(g[l]||{});for(const s of e){const o=P(s.realizado,s.metaPiso),t=`${i}-${l}-${s.corretorId}`;o>=100&&!I.current.has(t)&&(I.current.add(t),ce({particleCount:100,spread:70,origin:{y:.65}}))}},[g,l,i]);const Q=()=>{const e=$.map(s=>{var o;return{Corretor:s.nome,"Meta Piso":s.metaPiso,Realizado:s.realizado,Progresso:Math.round(P(s.realizado,s.metaPiso)),Observacoes:s.observacoes||"",Mes:(o=y.find(t=>t.key===s.mes))==null?void 0:o.label,Ano:s.ano}});de(`metas_${i}_${l+1}.xlsx`,e)},U=()=>{const e=$.map(s=>({corretor:s.nome,metaPiso:w(s.metaPiso),realizado:w(s.realizado),progresso:`${Math.round(P(s.realizado,s.metaPiso))}%`,obs:s.observacoes||""}));me(`metas_${i}_${l+1}.pdf`,e,[{header:"Corretor",key:"corretor"},{header:"Meta Piso",key:"metaPiso"},{header:"Realizado",key:"realizado"},{header:"Progresso",key:"progresso"},{header:"ObservaÃ§Ãµes",key:"obs"}])};return a.jsxs("div",{className:"p-4 md:p-6 space-y-4",children:[a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[a.jsx("h1",{className:"text-xl md:text-2xl font-semibold",children:"Metas Individuais dos Corretores"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(A,{variant:"secondary",onClick:Q,children:"Exportar Excel"}),a.jsx(A,{variant:"secondary",onClick:U,children:"Exportar PDF"})]})]}),a.jsx(V,{className:"p-3 md:p-4",children:a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[a.jsx("div",{className:"hidden md:block",children:a.jsxs(se,{value:String(l),onValueChange:e=>p(Number(e)),children:[a.jsx(oe,{className:"grid grid-cols-6 lg:grid-cols-12",children:y.map(e=>a.jsx(te,{value:String(e.key),children:e.label},e.key))}),a.jsx(re,{value:String(l)})]})}),a.jsx("div",{className:"md:hidden w-full max-w-xs",children:a.jsxs(T,{value:String(l),onValueChange:e=>p(Number(e)),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"MÃªs"})}),a.jsx(R,{children:y.map(e=>a.jsx(D,{value:String(e.key),children:e.label},e.key))})]})}),a.jsx("div",{className:"w-full md:w-auto max-w-[140px]",children:a.jsxs(T,{value:String(i),onValueChange:e=>N(Number(e)),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"Ano"})}),a.jsx(R,{children:[i-1,i,i+1].map(e=>a.jsx(D,{value:String(e),children:e},e))})]})})]})}),a.jsxs(V,{className:"p-3 md:p-4",children:[a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-2",children:[a.jsx("div",{className:"font-medium",children:"Comparativo Mensal"}),a.jsx("div",{className:"w-full md:w-64",children:a.jsxs(T,{value:S??"",onValueChange:e=>O(e),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"Selecione o corretor"})}),a.jsx(R,{children:m.map(e=>a.jsx(D,{value:e.id,children:e.nome},e.id))})]})})]}),a.jsx("div",{className:"h-72 w-full",children:a.jsx(ue,{children:a.jsxs(xe,{data:H,margin:{top:8,right:16,left:0,bottom:0},children:[a.jsx(fe,{dataKey:"mes"}),a.jsx(he,{tickFormatter:e=>`${(Number(e)/1e3).toFixed(0)}k`}),a.jsx(pe,{formatter:e=>w(Number(e))}),a.jsx(je,{}),a.jsx(Y,{dataKey:"metaPiso",fill:"#3b82f6",name:"Meta Piso"}),a.jsx(Y,{dataKey:"realizado",fill:"#22c55e",name:"Realizado"})]})})})]}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(ne,{children:[a.jsx(ie,{children:a.jsxs(K,{children:[a.jsx(M,{children:"Corretor"}),a.jsx(M,{children:"Meta Piso"}),a.jsx(M,{children:"Realizado"}),a.jsx(M,{children:"ObservaÃ§Ãµes"}),a.jsx(M,{className:"min-w-[260px]",children:"Progresso"})]})}),a.jsx(le,{children:$.map(e=>{const s=P(e.realizado,e.metaPiso),o=be(s),t=Math.max(0,e.metaPiso-e.realizado),c=s>=100;return a.jsxs(K,{className:"align-middle",children:[a.jsxs(C,{className:"font-medium whitespace-nowrap",children:[c?a.jsx("span",{className:"mr-1",children:"ðŸ”¥"}):null,e.nome]}),a.jsx(C,{className:"whitespace-nowrap",children:a.jsx(ve,{value:e.metaPiso,display:w(e.metaPiso),onChange:async u=>{Z(e.corretorId,l,u),await J(e.corretorId,l,u)}})}),a.jsx(C,{className:"whitespace-nowrap",children:w(e.realizado)}),a.jsx(C,{className:"whitespace-nowrap max-w-[260px]",children:a.jsx(ye,{value:e.observacoes||"",placeholder:"Adicionar observaÃ§Ãµes...",onChange:async u=>{G(e.corretorId,l,u),await q(e.corretorId,l,u)}})}),a.jsx(C,{children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-48",children:a.jsx(ge,{value:s,colorClass:o})}),a.jsxs("div",{className:"text-sm text-muted-foreground whitespace-nowrap",children:[Math.round(s),"% ",t>0?`â€¢ falta ${w(t)}`:"â€¢ meta batida"]})]})})]},`${e.corretorId}-${l}`)})})]})})]})}function ve({value:n,display:x,onChange:i}){const[N,l]=d.useState(!1),[p,m]=d.useState(n||0);return d.useEffect(()=>m(n||0),[n]),N?a.jsx(X,{autoFocus:!0,type:"number",className:"h-8 w-32",value:p,onChange:f=>m(Number(f.target.value)),onBlur:async()=>{l(!1),await i(p||0)},onKeyDown:async f=>{f.key==="Enter"&&f.target.blur()}}):a.jsx("button",{className:"hover:underline",onClick:()=>l(!0),children:x})}function ye({value:n,placeholder:x,onChange:i}){const[N,l]=d.useState(!1),[p,m]=d.useState(n||"");return d.useEffect(()=>m(n||""),[n]),N?a.jsx(X,{autoFocus:!0,type:"text",className:"h-8 w-64",value:p,placeholder:x,onChange:f=>m(f.target.value),onBlur:async()=>{l(!1),await i(p||"")},onKeyDown:async f=>{f.key==="Enter"&&f.target.blur()}}):a.jsx("button",{className:"hover:underline text-left break-words max-w-[240px]",onClick:()=>l(!0),children:n||a.jsx("span",{className:"text-muted-foreground",children:x||"Adicionar"})})}export{Re as default};
