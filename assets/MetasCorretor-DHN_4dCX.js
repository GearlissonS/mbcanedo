import{r as c,_ as $,j as a,B as L,Y as A}from"./index-BEfNt5Qr.js";import{C as V}from"./card-BBvzVULv.js";import{I as H}from"./index-O0gBUSYV.js";import{T as ae,a as se,b as te,c as oe}from"./tabs-BQrGC8cg.js";import{S as T,a as _,b as B,c as E,d as F}from"./select-Jedk2JT6.js";import{T as re,a as ne,b as K,c as N,d as le,e as k}from"./table-B4XzalfJ.js";import{c as ie}from"./confetti.module-xXOCn_3V.js";import{a as ce,b as de}from"./exporters-DpqARJEo.js";import{a7 as me,a8 as ue,a9 as xe,aa as he,ab as fe,ac as pe,ad as Y}from"./BarChart-DCDz5Yrd.js";import"./index-BZE8TNrO.js";import"./check-DjnL3u2i.js";const g=[{key:0,label:"Jan"},{key:1,label:"Fev"},{key:2,label:"Mar"},{key:3,label:"Abr"},{key:4,label:"Mai"},{key:5,label:"Jun"},{key:6,label:"Jul"},{key:7,label:"Ago"},{key:8,label:"Set"},{key:9,label:"Out"},{key:10,label:"Nov"},{key:11,label:"Dez"}];function y(r){return`R$ ${Math.round(r||0).toLocaleString("pt-BR")}`}function S(r,m){return!m||m<=0?0:Math.max(0,Math.min(100,r/m*100))}function je(r){return r>=90?"bg-green-500":r>=50?"bg-yellow-500":"bg-red-500"}function be({value:r,colorClass:m}){return a.jsx("div",{className:"h-2 w-full rounded bg-muted",children:a.jsx("div",{className:`h-2 rounded ${m}`,style:{width:`${Math.max(0,Math.min(100,r))}%`}})})}function Ee(){const r=new Date,m=r.getFullYear(),[l,w]=c.useState(m),[n,f]=c.useState(r.getMonth()),[d,u]=c.useState([]),[v,M]=c.useState({}),[C,D]=c.useState(null),[ye,I]=c.useState(!1),O=c.useRef(new Set);c.useEffect(()=>{let e=!0;return(async()=>{try{const s=await $("corretores",{select:"id, nome",order:"nome"});if(!e)return;u(s),D(t=>t??s?.[0]?.id??null)}catch(s){console.warn("[MetasCorretor] Falha ao carregar corretores, usando lista vazia.",s),u([])}})(),()=>{e=!1}},[]),c.useEffect(()=>{let e=!0;return(async()=>{if(d.length){I(!0);try{const s=await $("metas_corretor",{select:"corretor_id, mes, ano, meta_piso, observacoes"}),t=new Date(l,0,1).toISOString(),i=new Date(l+1,0,1).toISOString(),x=await $("vendas",{select:"vendedor, vgv, dataCompetencia"}),p=new Map(d.map(o=>[o.id,o.nome])),Z=new Map(d.map(o=>[o.nome,o.id])),z=new Map;for(const o of x??[]){const h=o.vendedor,b=h?Z.get(h):void 0;if(!b)continue;const ee=new Date(o.dataCompetencia).getMonth(),R=`${b}-${ee}`;z.set(R,(z.get(R)||0)+(Number(o.vgv)||0))}const j={};for(const o of g)j[o.key]={};for(const o of d)for(const h of g)j[h.key][o.id]={corretorId:o.id,nome:p.get(o.id)||o.id,ano:l,mes:h.key,metaPiso:0,realizado:z.get(`${o.id}-${h.key}`)||0,observacoes:void 0};for(const o of s??[]){const h=o.corretor_id,b=Number(o.mes)-1;!j[b]||!j[b][h]||(j[b][h].metaPiso=Number(o.meta_piso)||0,j[b][h].observacoes=o.observacoes||void 0)}if(!e)return;M(j)}catch(s){console.warn("[MetasCorretor] Falha ao carregar metas/vendas, usando dados vazios.",s);const t={};for(const i of g)t[i.key]={};M(t)}finally{e&&I(!1)}}})(),()=>{e=!1}},[l,d]);const P=c.useMemo(()=>Object.values(v[n]||{}),[v,n]),J=c.useMemo(()=>C?g.map(({key:e,label:s})=>{const t=v[e]?.[C];return{mes:s,metaPiso:t?.metaPiso||0,realizado:t?.realizado||0}}):[],[C,v]);async function X(e,s,t){const i={corretor_id:e,ano:l,mes:s+1,meta_piso:t};try{await A("metas_corretor",i)}catch(x){console.warn("[MetasCorretor] Falha ao salvar meta_piso.",x)}}async function q(e,s,t){const i={corretor_id:e,ano:l,mes:s+1,observacoes:t};try{await A("metas_corretor",i)}catch(x){console.warn("[MetasCorretor] Falha ao salvar observaÃ§Ãµes.",x)}}const G=(e,s,t)=>{M(i=>({...i,[s]:{...i[s],[e]:{...i[s]?.[e]||{corretorId:e,nome:d.find(x=>x.id===e)?.nome||e,ano:l,mes:s,realizado:0},metaPiso:t}}}))},Q=(e,s,t)=>{M(i=>({...i,[s]:{...i[s],[e]:{...i[s]?.[e]||{corretorId:e,nome:d.find(x=>x.id===e)?.nome||e,ano:l,mes:s,realizado:0},observacoes:t}}}))};c.useEffect(()=>{const e=Object.values(v[n]||{});for(const s of e){const t=S(s.realizado,s.metaPiso),i=`${l}-${n}-${s.corretorId}`;t>=100&&!O.current.has(i)&&(O.current.add(i),ie({particleCount:100,spread:70,origin:{y:.65}}))}},[v,n,l]);const U=()=>{const e=P.map(s=>({Corretor:s.nome,"Meta Piso":s.metaPiso,Realizado:s.realizado,Progresso:Math.round(S(s.realizado,s.metaPiso)),Observacoes:s.observacoes||"",Mes:g.find(t=>t.key===s.mes)?.label,Ano:s.ano}));ce(`metas_${l}_${n+1}.xlsx`,e)},W=()=>{const e=P.map(s=>({corretor:s.nome,metaPiso:y(s.metaPiso),realizado:y(s.realizado),progresso:`${Math.round(S(s.realizado,s.metaPiso))}%`,obs:s.observacoes||""}));de(`metas_${l}_${n+1}.pdf`,e,[{header:"Corretor",key:"corretor"},{header:"Meta Piso",key:"metaPiso"},{header:"Realizado",key:"realizado"},{header:"Progresso",key:"progresso"},{header:"ObservaÃ§Ãµes",key:"obs"}])};return a.jsxs("div",{className:"p-4 md:p-6 space-y-4",children:[a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[a.jsx("h1",{className:"text-xl md:text-2xl font-semibold",children:"Metas Individuais dos Corretores"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(L,{variant:"secondary",onClick:U,children:"Exportar Excel"}),a.jsx(L,{variant:"secondary",onClick:W,children:"Exportar PDF"})]})]}),a.jsx(V,{className:"p-3 md:p-4",children:a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[a.jsx("div",{className:"hidden md:block",children:a.jsxs(ae,{value:String(n),onValueChange:e=>f(Number(e)),children:[a.jsx(se,{className:"grid grid-cols-6 lg:grid-cols-12",children:g.map(e=>a.jsx(te,{value:String(e.key),children:e.label},e.key))}),a.jsx(oe,{value:String(n)})]})}),a.jsx("div",{className:"md:hidden w-full max-w-xs",children:a.jsxs(T,{value:String(n),onValueChange:e=>f(Number(e)),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"MÃªs"})}),a.jsx(E,{children:g.map(e=>a.jsx(F,{value:String(e.key),children:e.label},e.key))})]})}),a.jsx("div",{className:"w-full md:w-auto max-w-[140px]",children:a.jsxs(T,{value:String(l),onValueChange:e=>w(Number(e)),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"Ano"})}),a.jsx(E,{children:[l-1,l,l+1].map(e=>a.jsx(F,{value:String(e),children:e},e))})]})})]})}),a.jsxs(V,{className:"p-3 md:p-4",children:[a.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-2",children:[a.jsx("div",{className:"font-medium",children:"Comparativo Mensal"}),a.jsx("div",{className:"w-full md:w-64",children:a.jsxs(T,{value:C??"",onValueChange:e=>D(e),children:[a.jsx(_,{children:a.jsx(B,{placeholder:"Selecione o corretor"})}),a.jsx(E,{children:d.map(e=>a.jsx(F,{value:e.id,children:e.nome},e.id))})]})})]}),a.jsx("div",{className:"h-72 w-full",children:a.jsx(me,{children:a.jsxs(ue,{data:J,margin:{top:8,right:16,left:0,bottom:0},children:[a.jsx(xe,{dataKey:"mes"}),a.jsx(he,{tickFormatter:e=>`${(Number(e)/1e3).toFixed(0)}k`}),a.jsx(fe,{formatter:e=>y(Number(e))}),a.jsx(pe,{}),a.jsx(Y,{dataKey:"metaPiso",fill:"#3b82f6",name:"Meta Piso"}),a.jsx(Y,{dataKey:"realizado",fill:"#22c55e",name:"Realizado"})]})})})]}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(re,{children:[a.jsx(ne,{children:a.jsxs(K,{children:[a.jsx(N,{children:"Corretor"}),a.jsx(N,{children:"Meta Piso"}),a.jsx(N,{children:"Realizado"}),a.jsx(N,{children:"ObservaÃ§Ãµes"}),a.jsx(N,{className:"min-w-[260px]",children:"Progresso"})]})}),a.jsx(le,{children:P.map(e=>{const s=S(e.realizado,e.metaPiso),t=je(s),i=Math.max(0,e.metaPiso-e.realizado),x=s>=100;return a.jsxs(K,{className:"align-middle",children:[a.jsxs(k,{className:"font-medium whitespace-nowrap",children:[x?a.jsx("span",{className:"mr-1",children:"ðŸ”¥"}):null,e.nome]}),a.jsx(k,{className:"whitespace-nowrap",children:a.jsx(ge,{value:e.metaPiso,display:y(e.metaPiso),onChange:async p=>{G(e.corretorId,n,p),await X(e.corretorId,n,p)}})}),a.jsx(k,{className:"whitespace-nowrap",children:y(e.realizado)}),a.jsx(k,{className:"whitespace-nowrap max-w-[260px]",children:a.jsx(ve,{value:e.observacoes||"",placeholder:"Adicionar observaÃ§Ãµes...",onChange:async p=>{Q(e.corretorId,n,p),await q(e.corretorId,n,p)}})}),a.jsx(k,{children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-48",children:a.jsx(be,{value:s,colorClass:t})}),a.jsxs("div",{className:"text-sm text-muted-foreground whitespace-nowrap",children:[Math.round(s),"% ",i>0?`â€¢ falta ${y(i)}`:"â€¢ meta batida"]})]})})]},`${e.corretorId}-${n}`)})})]})})]})}function ge({value:r,display:m,onChange:l}){const[w,n]=c.useState(!1),[f,d]=c.useState(r||0);return c.useEffect(()=>d(r||0),[r]),w?a.jsx(H,{autoFocus:!0,type:"number",className:"h-8 w-32",value:f,onChange:u=>d(Number(u.target.value)),onBlur:async()=>{n(!1),await l(f||0)},onKeyDown:async u=>{u.key==="Enter"&&u.target.blur()}}):a.jsx("button",{className:"hover:underline",onClick:()=>n(!0),children:m})}function ve({value:r,placeholder:m,onChange:l}){const[w,n]=c.useState(!1),[f,d]=c.useState(r||"");return c.useEffect(()=>d(r||""),[r]),w?a.jsx(H,{autoFocus:!0,type:"text",className:"h-8 w-64",value:f,placeholder:m,onChange:u=>d(u.target.value),onBlur:async()=>{n(!1),await l(f||"")},onKeyDown:async u=>{u.key==="Enter"&&u.target.blur()}}):a.jsx("button",{className:"hover:underline text-left break-words max-w-[240px]",onClick:()=>n(!0),children:r||a.jsx("span",{className:"text-muted-foreground",children:m||"Adicionar"})})}export{Ee as default};
